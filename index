<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS æ¥•å††ãƒœãƒ¼ãƒ‰ã™ã”ã‚ãã‚²ãƒ¼ãƒ  (3Dã‚µã‚¤ã‚³ãƒ­)</title>
    <!-- Tailwind CSS ãƒ­ãƒ¼ãƒ‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ  CSS ãŠã‚ˆã³ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã®æ¯”ç‡ç¶­æŒã®ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
        .board-wrapper {
            position: relative;
            width: 100%;
            /* 4:3 æ¯”ç‡ã®ãƒœãƒ¼ãƒ‰ã®ãŸã‚ã« max-width åŸºæº–ã®é«˜ã•è¨­å®š (75%) */
            padding-top: 75%; 
            max-width: 800px;
            margin: 20px auto;
            background-color: #e5e7eb;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .board-container {
            /* ãƒã‚¹ãŒçµ¶å¯¾ä½ç½®ã§é…ç½®ã•ã‚Œã‚‹é ˜åŸŸ */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* å€‹åˆ¥ãƒã‚¹ã®ãƒ©ãƒƒãƒ‘ãƒ¼ (é§’ã¨ãƒã‚¹ã®ä½ç½®åŸºæº–) */
        .step-wrapper {
            position: absolute; 
            width: 70px; 
            height: 70px; 
            transform: translate(-50%, -50%); /* ä¸­å¿ƒã‚’åŸºæº–ã«ä½ç½®èª¿æ•´ */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .step {
            /* åŸå‹ã‚¹ã‚¿ã‚¤ãƒ«: å®Œå…¨ãªå††å½¢ */
            border-radius: 50%; 
            width: 60px; /* ê³ ì • í¬ê¸° */
            height: 60px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            text-align: center;
            line-height: 1.2;
            color: #1f2937; /* åŸºæœ¬ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ©ãƒ¼ */
        }
        
        /* ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«é©ç”¨ã•ã‚Œã‚‹ã‚¹ã‚¿ã‚¤ãƒ«: ä¸¸ã„å››è§’å½¢ã«æ‹¡å¤§ (åŠ¹æœè¡¨ç¤ºç”¨) */
        .step.hover-show-effect {
            border-radius: 12px; /* ä¸¸ã„å››è§’å½¢ */
            width: 110px; 
            height: 110px; 
            flex-direction: column; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¸¦ã«é…ç½® */
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: scale(1.2); /* å‘¨å›²ã¨åŒºåˆ¥ã•ã‚Œã‚‹ã‚ˆã†ã«å°‘ã—æ‹¡å¤§ */
            z-index: 20; /* ä»–ã®è¦ç´ ã®ä¸Šã«è¡¨ç¤º */
        }

        /* é§’ãŒç¾åœ¨ä½ç½®ã™ã‚‹ãƒã‚¹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .current-step {
            border-color: #3b82f6;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
        }
        
        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ (0ç•ª) ç‰¹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        #step-0 {
             background-color: #374151;
             color: white;
             font-size: 1.25rem;
             font-weight: 700;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é§’ã‚¹ã‚¿ã‚¤ãƒ« */
        .piece {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            transition: transform 0.5s ease-in-out; 
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            /* ãƒã‚¹ä¸­å¤®ã‚’åŸºæº–ã«ä½ç½®èª¿æ•´ */
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #playerPiece { background-color: #ef4444; top: 30%; z-index: 11;} /* ä¸Šå´ */
        #cpuPiece { background-color: #3b82f6; top: 70%; z-index: 11;} /* ä¸‹å´ */

        /* --- 3D ã‚µã‚¤ã‚³ãƒ­ ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #diceArea {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            perspective: 500px; /* 3D å¥¥è¡Œãã‚’è¿½åŠ  */
        }
        
        .dice-cube {
            position: relative;
            width: 80px;
            height: 80px;
            transform-style: preserve-3d;
            transition: transform 1.5s ease-out; /* åœæ­¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            transform: rotateX(-20deg) rotateY(20deg); /* åˆæœŸè¡¨ç¤ºè§’åº¦ */
        }

        .face {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 2px solid #3b82f6;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: #374151;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        /* å„é¢ã®ä½ç½®èª¿æ•´ */
        .front  { transform: rotateY(0deg) translateZ(40px); }
        .back   { transform: rotateY(180deg) translateZ(40px); }
        .right  { transform: rotateY(90deg) translateZ(40px); }
        .left   { transform: rotateY(-90deg) translateZ(40px); }
        .top    { transform: rotateX(90deg) translateZ(40px); }
        .bottom { transform: rotateX(-90deg) translateZ(40px); }

        /* å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ (é€£ç¶šå›è»¢) */
        @keyframes tumble {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
            100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg); }
        }
        .rolling {
            animation: tumble 0.1s infinite linear; /* ç·šå½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§ç¶™ç¶šå›è»¢ */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ğŸ² GAS æ¥•å††ãƒœãƒ¼ãƒ‰ã™ã”ã‚ãã‚²ãƒ¼ãƒ  ğŸ²</h1>
        <p class="text-center text-gray-500 mb-6">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼(ğŸ”´) vs ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿(ğŸ”µ)ã€‚å…¨30ã‚¹ãƒ†ãƒ¼ã‚¸ï¼</p>

        <!-- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŠã‚ˆã³ã‚µã‚¤ã‚³ãƒ­é ˜åŸŸ (ä¸Šéƒ¨ã«é…ç½®) -->
        <div class="flex flex-col md:flex-row items-center justify-center bg-gray-100 p-4 rounded-lg shadow-inner mb-6 space-y-4 md:space-y-0 md:space-x-8">
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="statusMessage" class="text-xl font-semibold h-8 text-center text-red-600 w-full md:w-1/3 flex items-center justify-center">
                ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚
            </div>
            
            <!-- ã‚µã‚¤ã‚³ãƒ­ãƒœã‚¿ãƒ³ (ãƒœãƒ¼ãƒ‰ä¸­å¤®ã§ã¯ãªã ìœ„ìª½ ìƒíƒœì°½ì— ë°°ì¹˜) -->
            <div class="flex flex-col items-center w-full md:w-1/3">
                <button id="rollButton" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-150 ease-in-out transform hover:scale-105 disabled:opacity-50"
                        onclick="rollDice()">
                    ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ (è‡ªå‹•åœæ­¢)
                </button>
            </div>
            
            <!-- çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="gameResult" class="text-center text-2xl font-extrabold text-green-700 hidden w-full md:w-1/3 p-2 bg-yellow-100 rounded-lg"></div>

        </div>

        <!-- ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ (ã‚¿ãƒ¯ãƒ¼çµŒè·¯) -->
        <div class="board-wrapper">
            <div id="diceArea">
                <!-- 3Dã‚µã‚¤ã‚³ãƒ­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
                <div id="dice-cube" class="dice-cube">
                    <div class="face front" data-num="1">1</div>
                    <div class="face back" data-num="6">6</div>
                    <div class="face right" data-num="3">3</div>
                    <div class="face left" data-num="4">4</div>
                    <div class="face top" data-num="5">5</div>
                    <div class="face bottom" data-num="2">2</div>
                </div>
            </div>
            <div id="gameBoard" class="board-container">
                <!-- JavaScript ãŒã“ã“ã«ãƒã‚¹ã¨é§’ã‚’ç”Ÿæˆã—ã¾ã™ -->
            </div>
        </div>

    </div>

<script>
    // å®šæ•°
    const NUM_STEPS = 30; // 1ç•ªã‹ã‚‰30ç•ªã¾ã§ã®ã‚²ãƒ¼ãƒ ãƒã‚¹
    const TOTAL_TILES = 31; // 0ç•ª(ã‚¹ã‚¿ãƒ¼ãƒˆ) + 1ã€œ30ç•ªã®ãƒã‚¹
    const WIN_STEP = NUM_STEPS;
    const STEP_COLORS = ['bg-yellow-300', 'bg-green-300', 'bg-red-300', 'bg-purple-300'];

    // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹
    let playerPos = 0; // ã‚¹ã‚¿ãƒ¼ãƒˆã¯0ç•ªãƒã‚¹
    let cpuPos = 0;
    let currentPlayer = 'player'; // 'player' ã¾ãŸã¯ 'cpu'
    let isRolling = false;
    let isAnimating = false;
    let isGameOver = false;

    // DOM è¦ç´ 
    const board = document.getElementById('gameBoard');
    const rollButton = document.getElementById('rollButton');
    const statusMessage = document.getElementById('statusMessage');
    const gameResult = document.getElementById('gameResult');
    const diceCube = document.getElementById('dice-cube'); // 3Dã‚µã‚¤ã‚³ãƒ­è¦ç´ 

    // é§’ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã€ã“ã“ã«æ ¼ç´ã•ã‚Œã¾ã™
    let playerPiece = null;
    let cpuPiece = null;

    // ãƒã‚¹åŠ¹æœãƒãƒƒãƒ— (0ç•ªã‹ã‚‰30ç•ªã¾ã§)
    const stepEffects = {
        0: { name: "ã‚¹ã‚¿ãƒ¼ãƒˆ", effect: "ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦1ç•ªãƒã‚¹ã¸ç§»å‹•ã—ã¾ã™ã€‚", type: "start" },
        3: { name: "ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¹", effect: "å‰ã«2ãƒã‚¹é€²ã‚€ï¼", move: 2, type: "bonus" },
        7: { name: "ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒã‚¹", effect: "å¾Œã‚ã«3ãƒã‚¹æˆ»ã‚‹ï¼", move: -3, type: "penalty" },
        12: { name: "ã‚‚ã†ä¸€åº¦", effect: "ã‚µã‚¤ã‚³ãƒ­ã‚’ã‚‚ã†ä¸€åº¦æŒ¯ã‚Šã¾ã™ã€‚", extraTurn: true, type: "extra" },
        18: { name: "CPUå¦¨å®³", effect: "CPUã®æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚", skipNext: 'cpu', type: "bonus" },
        25: { name: "ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒã‚¹", effect: "å¾Œã‚ã«5ãƒã‚¹æˆ»ã‚‹ï¼", move: -5, type: "penalty" },
        30: { name: "ã‚´ãƒ¼ãƒ«", effect: "å‹åˆ©ï¼ ğŸ‰", type: "win" }
    };

    /**
     * íƒ€ì›í˜• ê²½ë¡œì— ë”°ë¼ ë§ˆìŠ¤ì˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ HTMLì„ ìƒì„±í•˜ê³  DOMì— ì¶”ê°€í•©ë‹ˆë‹¤.
     */
    function createBoard() {
        board.innerHTML = '';
        
        // --- íƒ€ì› ê²½ë¡œ ìœ„ì¹˜ ê³„ì‚° ì„¤ì • (í¼ì„¼íŠ¸ ê¸°ì¤€) ---
        const CENTER_X = 50; // ä¸­å¤® X (50%)
        const CENTER_Y = 50; // ä¸­å¤® Y (50%)
        const R_X = 35; // ê°€ë¡œ ë°˜ì§€ë¦„ (35%)
        const R_Y = 30; // ì„¸ë¡œ ë°˜ì§€ë¦„ (30%)
        // 30ê°œì˜ ë§ˆìŠ¤ë¥¼ íƒ€ì› ê²½ë¡œì— ë”°ë¼ ë°°ì¹˜í•©ë‹ˆë‹¤.
        const ANGLE_STEP = (2 * Math.PI) / (TOTAL_TILES - 1); // 30ê°œì˜ ì„¸ê·¸ë¨¼íŠ¸
        const ANGLE_OFFSET = Math.PI * 1.5; // ì‹œì‘ì ì„ ìƒë‹¨ ì¤‘ì•™(270ë„) ê·¼ì²˜ë¡œ ì„¤ì •

        
        // é§’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ (ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ ¼ç´)
        playerPiece = document.createElement('div');
        playerPiece.id = 'playerPiece';
        playerPiece.className = 'piece bg-red-500';
        playerPiece.style.top = '30%'; 
        playerPiece.textContent = 'P';

        cpuPiece = document.createElement('div');
        cpuPiece.id = 'cpuPiece';
        cpuPiece.className = 'piece bg-blue-500';
        cpuPiece.style.top = '70%'; 
        cpuPiece.textContent = 'C';


        for (let i = 0; i < TOTAL_TILES; i++) {
            const stepNum = i;
            const isStart = stepNum === 0;
            
            // "é€šå¸¸ãƒã‚¹" ã‚’æ’é™¤ã—ã€é€šå¸¸ã®ãƒã‚¹ã¯ "${stepNum}ç•ª" ã®åå‰ã‚’æŒã¤ã‚ˆã†ã« ìˆ˜ì •
            const effect = stepEffects[stepNum] || { name: `${stepNum}ç•ª`, effect: "ä½•ã‚‚èµ·ã“ã‚Šã¾ã›ã‚“ã€‚", type: "normal" };
            const colorClass = isStart ? 'bg-gray-400' : STEP_COLORS[stepNum % STEP_COLORS.length];

            let x, y;

            if (isStart) {
                // 'ã‚¹ã‚¿ãƒ¼ãƒˆ' (0ë²ˆ) ë°œíŒì„ 1ë²ˆ ë°œíŒì˜ ê²½ë¡œ ì‹œì‘ì  ë°”ë¡œ ì˜†ì— ëª…í™•í•˜ê²Œ ë°°ì¹˜ (ì¢Œí‘œ ìˆ˜ë™ ì˜¤í”„ì…‹)
                const angle1 = 1 * ANGLE_STEP + ANGLE_OFFSET;
                x = CENTER_X + R_X * Math.cos(angle1) - 10;
                y = CENTER_Y + R_Y * Math.sin(angle1) - 10;
                
            } else {
                // 1ë²ˆë¶€í„° 30ë²ˆê¹Œì§€ íƒ€ì›í˜• ê²½ë¡œë¥¼ ë”°ë¼ ë°°ì¹˜
                const angle = (i - 1) * ANGLE_STEP + ANGLE_OFFSET; 
                x = CENTER_X + R_X * Math.cos(angle);
                y = CENTER_Y + R_Y * Math.sin(angle);
            }
            
            // ãƒ©ãƒƒãƒ‘ãƒ¼ç”Ÿæˆ
            const stepWrapper = document.createElement('div');
            stepWrapper.id = `step-wrapper-${stepNum}`;
            stepWrapper.className = `step-wrapper group z-50`; 
            // çµ¶å¯¾ä½ç½®è¨­å®š (ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆä½¿ç”¨)
            stepWrapper.style.left = `${x}%`;
            stepWrapper.style.top = `${y}%`;
            
            // ãƒã‚¹æœ¬ä½“
            const stepDiv = document.createElement('div');
            stepDiv.id = `step-${stepNum}`;
            stepDiv.dataset.step = stepNum;
            stepDiv.dataset.name = isStart ? 'ã‚¹ã‚¿ãƒ¼ãƒˆ' : effect.name;
            stepDiv.dataset.effect = effect.effect;
            stepDiv.className = `step ${colorClass} text-gray-800 transition duration-150 ease-in-out`;
            stepDiv.innerHTML = `<span>${isStart ? 'ã‚¹ã‚¿ãƒ¼ãƒˆ' : stepNum}</span>`;
            
            stepWrapper.appendChild(stepDiv);

            // åˆæœŸä½ç½® (0ç•ªãƒã‚¹ã«é§’ã‚’é…ç½®)
            if (isStart) {
                stepWrapper.appendChild(playerPiece);
                stepWrapper.appendChild(cpuPiece);
            }
            
            // ãƒã‚¹ãƒ›ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ : ãƒã‚¹ã®å½¢ã¨å†…å®¹ã‚’ç›´æ¥å¤‰æ›´
            stepWrapper.addEventListener('mouseenter', showEffectDetails);
            stepWrapper.addEventListener('mouseleave', hideEffectDetails);

            board.appendChild(stepWrapper);
        }

        // æœ€çµ‚ãƒã‚¹å¼·èª¿ (30ç•ª)
        const finalStep = document.getElementById(`step-${WIN_STEP}`);
        if(finalStep) {
            finalStep.classList.add('bg-yellow-500', 'ring-4', 'ring-yellow-400', 'text-white', 'text-lg');
            finalStep.classList.remove('bg-yellow-300');
        }

        // åˆæœŸä½ç½®ãƒã‚¤ãƒ©ã‚¤ãƒˆ (0ë²ˆ ë§ˆìŠ¤)
        const startStep = document.getElementById('step-0');
        if (startStep) startStep.classList.add('current-step');
    }

    /**
     * ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã€è‡ªå‹•ã§åœæ­¢ã—ã¾ã™ã€‚
     */
    function rollDice() {
        if (isRolling || isAnimating || isGameOver) return;
        isRolling = true;
        rollButton.disabled = true; 

        // 3Dã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        diceCube.classList.add('rolling');
        
        statusMessage.textContent = `${currentPlayer === 'player' ? 'ğŸ”´ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'ğŸ”µ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿'}ãŒã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ã„ã¾ã™...`;

        // 1.5ç§’å¾Œã«è‡ªå‹•ã§åœæ­¢
        setTimeout(stopDice, 1500);
    }

    /**
     * ã‚µã‚¤ã‚³ãƒ­ã‚’æ­¢ã‚ã€çµæœã‚’å‡¦ç†ã—ã¾ã™ã€‚ (è‡ªå‹•åœæ­¢ç”¨)
     */
    function stopDice() {
        if (!isRolling) return;
        
        diceCube.classList.remove('rolling');
        
        const finalRoll = Math.floor(Math.random() * 6) + 1;
        
        // --- 3D ã‚µã‚¤ã‚³ãƒ­ã®åœæ­¢ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        // æœ€çµ‚çš„ãªé¢ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®åŸºæœ¬å›è»¢
        const rotations = {
            1: [0, 0, 0],   // front
            2: [90, 0, 0],  // bottom
            3: [0, -90, 0], // right
            4: [0, 90, 0],  // left
            5: [-90, 0, 0], // top
            6: [180, 0, 0]  // back (rotateX(180) or rotateY(180))
        };
        
        // ä¹±æ•°ã®å›è»¢æ•° (4~8å›è»¢)
        const randomTurns = Math.floor(Math.random() * 5 + 4) * 360; 
        
        // æœ€çµ‚ä½ç½®ã«å¿…è¦ãªå›è»¢ã‚’å–å¾—ã—ã€ãƒ©ãƒ³ãƒ€ãƒ ãªå›è»¢æ•°ã¨çµåˆ
        const [xBase, yBase, zBase] = rotations[finalRoll];
        
        // æœ€çµ‚å›è»¢å€¤ (ãƒ©ãƒ³ãƒ€ãƒ ãªå›è»¢ + æœ€çµ‚é¢)
        const finalX = randomTurns + xBase + Math.floor(Math.random() * 30) - 15; // ã‚ãšã‹ãªãƒ–ãƒ¬ã‚’è¿½åŠ 
        const finalY = randomTurns + yBase + Math.floor(Math.random() * 30) - 15;
        const finalZ = randomTurns + zBase + Math.floor(Math.random() * 30) - 15;
        
        diceCube.style.transform = `rotateX(${finalX}deg) rotateY(${finalY}deg) rotateZ(${finalZ}deg)`;
        
        // åœæ­¢ã—ãŸé¢ã®å†…å®¹ã‚’æ›´æ–° (ãªãã¦ã‚‚è‰¯ã„ãŒç¢ºèªç”¨)
        const faces = diceCube.querySelectorAll('.face');
        faces.forEach(face => {
            if (parseInt(face.dataset.num) === finalRoll) {
                face.style.opacity = 1;
            } else {
                face.style.opacity = 0.8; 
            }
        });
        
        isRolling = false;
        
        statusMessage.textContent = `${currentPlayer === 'player' ? 'ğŸ”´ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'ğŸ”µ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿'}ã®ã‚µã‚¤ã‚³ãƒ­ã®çµæœ: ${finalRoll}ï¼ ${finalRoll}ãƒã‚¹é€²ã¿ã¾ã™ã€‚`;
        
        setTimeout(() => handleMove(finalRoll), 500);
    }
    
    /**
     * é§’ã‚’æŒ‡å®šã•ã‚ŒãŸãƒã‚¹ã¸ç§»å‹•ã•ã›ã€è¦–è¦šçš„ã«æ›´æ–°ã—ã¾ã™ã€‚
     * ... (updatePiecePosition í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ) ...
     */
    async function updatePiecePosition(pieceId, newPos, oldPos) {
        const piece = pieceId === 'player' ? playerPiece : cpuPiece;
        
        // ä»¥å‰ã®ãƒã‚¹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
        if (oldPos >= 0 && oldPos < TOTAL_TILES) {
            const oldStep = document.getElementById(`step-${oldPos}`);
            if (oldStep) oldStep.classList.remove('current-step');
        }
        
        // æ–°ã—ã„ãƒã‚¹ã¸é§’ã‚’ç§»å‹•
        if (newPos >= 0 && newPos < TOTAL_TILES) {
            const newWrapper = document.getElementById(`step-wrapper-${newPos}`);
            const newStep = document.getElementById(`step-${newPos}`);
            
            if (newWrapper && newStep) {
                // é§’è¦ç´ ã‚’æ–°ã—ã„ãƒ©ãƒƒãƒ‘ãƒ¼ã¸ç§»å‹•
                newWrapper.appendChild(piece);
                newStep.classList.add('current-step');
            }
        }
    }

    /**
     * é§’ã‚’å‹•ã‹ã—ã€ãƒã‚¹åŠ¹æœã‚’é©ç”¨ã—ã€ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†ã—ã¾ã™ã€‚
     * ... (handleMove í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ) ...
     */
    async function handleMove(roll) {
        if (isAnimating) return;
        isAnimating = true;

        const pieceId = currentPlayer === 'player' ? 'player' : 'cpu';
        let oldPos = pieceId === 'player' ? playerPos : cpuPos;
        let newPos = oldPos;
        
        // ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (1ãƒã‚¹ãšã¤)
        for (let i = 1; i <= roll; i++) {
            newPos = oldPos + i;
            if (newPos > WIN_STEP) {
                newPos = WIN_STEP;
                i = roll; // ãƒ«ãƒ¼ãƒ—çµ‚äº†
            }
            
            if (pieceId === 'player') {
                playerPos = newPos;
            } else {
                cpuPos = newPos;
            }
            
            // 1ãƒã‚¹ãšã¤ç§»å‹•ã—ãªãŒã‚‰è¦–è¦šçš„ã«æ›´æ–°
            updatePiecePosition(pieceId, newPos, newPos - 1); 
            await new Promise(resolve => setTimeout(resolve, 350)); 
            
            if (newPos === WIN_STEP) break;
        }

        // æœ€çµ‚ä½ç½®
        let currentPos = pieceId === 'player' ? playerPos : cpuPos;
        
        // å‹åˆ©åˆ¤å®š
        if (currentPos === WIN_STEP) {
            endGame();
            return;
        }

        // ãƒã‚¹åŠ¹æœé©ç”¨ (0ç•ªãƒã‚¹ã¯åŠ¹æœãªã—)
        if (currentPos > 0) {
             await applyStepEffect(currentPos);
        }
        
        isAnimating = false;

        // ã‚¿ãƒ¼ãƒ³çµ‚äº†ã¨æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã®æº–å‚™
        if (!isGameOver) {
            // è¿½åŠ ã‚¿ãƒ¼ãƒ³ãŒãªã„å ´åˆã¯ã‚¿ãƒ¼ãƒ³å¤‰æ›´
            if (!stepEffects[currentPos] || !stepEffects[currentPos].extraTurn) {
                switchTurn();
            } else {
                statusMessage.textContent = `${pieceId === 'player' ? 'ğŸ”´ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'ğŸ”µ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿'}ï¼ ${stepEffects[currentPos].effect} ã‚‚ã†ä¸€åº¦æŒ¯ã£ã¦ãã ã•ã„ã€‚`;
                setTimeout(prepareTurn, 1000);
            }
        }
    }
    
    /**
     * ãƒã‚¹åŠ¹æœã‚’é©ç”¨ã—ã¾ã™ã€‚
     * ... (applyStepEffect í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ) ...
     */
    async function applyStepEffect(pos) {
        const effect = stepEffects[pos];
        if (!effect || effect.type === 'normal') return;

        const pieceId = currentPlayer === 'player' ? 'player' : 'cpu';
        
        statusMessage.textContent = `âš¡ï¸ ãƒã‚¹åŠ¹æœ: ${effect.effect}ï¼`;
        await new Promise(resolve => setTimeout(resolve, 1000));

        if (effect.move) {
            let oldPos = pieceId === 'player' ? playerPos : cpuPos;
            let newPos;
            const moveAmount = effect.move;

            if (pieceId === 'player') {
                // æœ€ä½1ç•ªãƒã‚¹ã‚’ç¶­æŒ (ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ã¸ã¯æˆ»ã‚‰ãªã„)
                playerPos = Math.max(1, Math.min(WIN_STEP, playerPos + moveAmount));
                newPos = playerPos;
            } else {
                cpuPos = Math.max(1, Math.min(WIN_STEP, cpuPos + moveAmount));
                newPos = cpuPos;
            }
            
            // åŠ¹æœã«ã‚ˆã‚‹ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            updatePiecePosition(pieceId, newPos, oldPos);
            await new Promise(resolve => setTimeout(resolve, 800)); 

            // åŠ¹æœã«ã‚ˆã£ã¦å‹åˆ©ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚Šå¾—ã¾ã™
            if (newPos === WIN_STEP) {
                endGame();
                return;
            }
        }
        
        // CPUã‚¿ãƒ¼ãƒ³ ã‚¹ã‚­ãƒƒãƒ—åŠ¹æœ
        if (effect.skipNext === 'cpu' && currentPlayer === 'player') {
            playerPiece.dataset.skipNextCpu = 'true';
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }

    /**
     * ã‚¿ãƒ¼ãƒ³ã‚’äº¤ä»£ã—ã¾ã™ã€‚
     * ... (switchTurn í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ) ...
     */
    function switchTurn() {
        currentPlayer = currentPlayer === 'player' ? 'cpu' : 'player';
        prepareTurn();
    }

    /**
     * ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç¢ºèªã—ã€æ¬¡ã®è¡Œå‹•ã‚’æº–å‚™ã—ã¾ã™ã€‚
     * ... (prepareTurn í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ) ...
     */
    function prepareTurn() {
        rollButton.disabled = false;
        
        // ì£¼ì‚¬ìœ„ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¼ (ì‹œê°ì  ë¦¬ì…‹)
        diceCube.style.transform = 'rotateX(0deg) rotateY(0deg) rotateZ(0deg)'; 
        diceCube.classList.remove('rolling'); 
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³
        if (currentPlayer === 'player') {
            statusMessage.textContent = 'ğŸ”´ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ãã ã•ã„ã€‚';
        
        // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ã‚¿ãƒ¼ãƒ³
        } else {
            // CPUã‚¿ãƒ¼ãƒ³ã®ã‚¹ã‚­ãƒƒãƒ—ç¢ºèª
            if (playerPiece.dataset.skipNextCpu === 'true') {
                statusMessage.textContent = 'ğŸ”µ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ã‚¿ãƒ¼ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚å†åº¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚';
                playerPiece.dataset.skipNextCpu = 'false';
                setTimeout(() => {
                    switchTurn(); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã«å†åº¦äº¤ä»£
                }, 1500);
            } else {
                statusMessage.textContent = 'ğŸ”µ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã€‚';
                rollButton.disabled = true; 
                setTimeout(cpuRollAndStop, 1500);
            }
        }
    }

    /**
     * ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿(CPU)ã®ã‚µã‚¤ã‚³ãƒ­æŒ¯ã‚ŠãŠã‚ˆã³åœæ­¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‡¦ç†ã—ã¾ã™ã€‚
     */
    function cpuRollAndStop() {
        rollDice();
    }
    
    /**
     * ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
     * ... (endGame í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ) ...
     */
    function endGame() {
        isGameOver = true;
        rollButton.disabled = true;
        diceCube.classList.remove('rolling');
        
        const winner = currentPlayer === 'player' ? 'ğŸ”´ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'ğŸ”µ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿';
        gameResult.textContent = `${winner}ãŒå‹åˆ©ã—ã¾ã—ãŸï¼ ğŸ‰`;
        gameResult.classList.remove('hidden');
        statusMessage.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†ï¼';
    }

    // --- UI/UX ã®ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° (åŠ¹æœè¡¨ç¤º) ---

    /**
     * ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼æ™‚ã€ãƒã‚¹ã®å½¢ã‚’ä¸¸ã„å››è§’å½¢ã«å¤‰æ›´ã—ã€åŠ¹æœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * ... (showEffectDetails í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ) ...
     */
    function showEffectDetails(e) {
        let stepWrapper = e.currentTarget;
        const stepDiv = stepWrapper.querySelector('.step');
        if (!stepDiv) return;
        
        const stepNum = stepDiv.dataset.step;
        const name = stepDiv.dataset.name;
        const effect = stepDiv.dataset.effect;
        const isStart = stepNum === '0';

        // 1. ä¸¸ã„å››è§’å½¢ã‚¹ã‚¿ã‚¤ãƒ«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã€z-indexã‚’èª¿æ•´
        stepDiv.classList.add('hover-show-effect');
        stepWrapper.style.zIndex = 20;
        
        // 2. å†…å®¹å¤‰æ›´ (ãƒã‚¹åŠ¹æœã®è¡¨ç¤º)
        stepDiv.innerHTML = `
            <div class="font-bold text-sm truncate">${name}</div>
            <div class="text-xs mt-1 text-center font-normal break-words">${effect}</div>
        `;

        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ã¯ãƒ•ã‚©ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã‚’ç¶­æŒã—ã¾ã™ã€‚
        if (isStart) {
             stepDiv.classList.remove('text-gray-800');
             stepDiv.classList.add('text-white');
        } else {
             stepDiv.classList.add('text-gray-800');
        }
    }

    /**
     * ãƒã‚¦ã‚¹ã‚¢ã‚¦ãƒˆæ™‚ã€ãƒã‚¹ã®å½¢ã‚’å…ƒã®å††å½¢ã«æˆ»ã—ã€ç•ªå·ã‚’å¾©å…ƒã—ã¾ã™ã€‚
     * ... (hideEffectDetails í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ) ...
     */
    function hideEffectDetails(e) {
        let stepWrapper = e.currentTarget;
        const stepDiv = stepWrapper.querySelector('.step');
        if (!stepDiv) return;

        const stepNum = stepDiv.dataset.step;
        const isStart = stepNum === '0';
        
        // 1. ã‚¹ã‚¿ã‚¤ãƒ«å¾©å…ƒ
        stepDiv.classList.remove('hover-show-effect');
        stepWrapper.style.zIndex = 5;
        
        // 2. å†…å®¹å¾©å…ƒ (ãƒã‚¹ç•ªå·ã¾ãŸã¯ 'ã‚¹ã‚¿ãƒ¼ãƒˆ')
        stepDiv.innerHTML = `<span>${isStart ? 'ã‚¹ã‚¿ãƒ¼ãƒˆ' : stepNum}</span>`;

         // ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ã¯ãƒ•ã‚©ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã‚’ç¶­æŒã—ã¾ã™ã€‚
        if (isStart) {
             stepDiv.classList.add('text-white');
             stepDiv.classList.remove('text-gray-800');
        } else {
             stepDiv.classList.remove('text-white');
             stepDiv.classList.add('text-gray-800');
        }
    }

    /**
     * åˆæœŸåŒ–é–¢æ•°
     */
    function initGame() {
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹åˆæœŸåŒ–
        playerPos = 0; // ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ (0ç•ª)
        cpuPos = 0;
        currentPlayer = 'player';
        isRolling = false;
        isAnimating = false;
        isGameOver = false;
        gameResult.classList.add('hidden');
        
        createBoard();
        prepareTurn();
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    window.onload = initGame;
</script>
</body>
</html>
